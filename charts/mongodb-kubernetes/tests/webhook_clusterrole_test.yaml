suite: test webhook consistent clusterrole and binding
templates:
  - operator-roles-webhook.yaml
tests:
  - it: should have consistent ClusterRole and ClusterRoleBinding names
    set:
      operator.webhook.registerConfiguration: true
      operator.webhook.installClusterRole: true
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ClusterRole
        documentIndex: 0
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 1
      - equal:
          path: metadata.name
          value: mongodb-kubernetes-operator-NAMESPACE-webhook-cr
        documentIndex: 0
      - equal:
          path: metadata.name
          value: mongodb-kubernetes-operator-NAMESPACE-webhook-crb
        documentIndex: 1
      - equal:
          path: roleRef.name
          value: mongodb-kubernetes-operator-NAMESPACE-webhook-cr
        documentIndex: 1

  # Test that different installations get unique names (prevents conflicts)
  - it: should create unique names per installation
    set:
      operator.name: my-operator
      operator.namespace: custom-ns
      operator.webhook.registerConfiguration: true
      operator.webhook.installClusterRole: true
    release:
      namespace: custom-ns
    asserts:
      - equal:
          path: metadata.name
          value: my-operator-custom-ns-webhook-cr
        documentIndex: 0
      - equal:
          path: metadata.name
          value: my-operator-custom-ns-webhook-crb
        documentIndex: 1
      - equal:
          path: roleRef.name
          value: my-operator-custom-ns-webhook-cr
        documentIndex: 1
